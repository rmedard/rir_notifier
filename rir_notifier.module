<?php
/**
 * @file
 * A description of what your module does.
 */

use Drupal\Core\Render\Markup;
use Drupal\Core\Url;
use Drupal\node\Entity\Node;
use Drupal\node\NodeInterface;

/**
 * Implements hook_page_attachments().
 * @param array $attachments
 */
function rir_notifier_page_attachments(array &$attachments)
{
    if (Drupal::currentUser()->isAnonymous()) {
        $attachments['#attached']['library'][] = 'rir_notifier/rir_scripts';
        $attachments['#attached']['library'][] = 'core/drupal.dialog.ajax';
    }
}

/**
 * Implements hook_theme().
 * @param $existing
 * @param $type
 * @param $theme
 * @param $path
 * @return array
 */
function rir_notifier_theme($existing, $type, $theme, $path): array
{
    return [
        'rir_subscribe_search' => [
            'variables' => [
                'button' => t('Subscribe'),
            ],
        ],
    ];
}

function getRequestCategoryReference($location, $advertType, $propertyType): string
{
    if (empty($location)) {
        $location = 'loc';
    }
    if (empty($advertType) or $advertType == 'All') {
        $advertType = 'ad';
    }
    if (empty($propertyType) or $propertyType == 'All') {
        $propertyType = 'pro';
    }
    return $location . '-' . $advertType . '-' . $propertyType;
}

/**
 * Implements hook_cron().
 */
function rir_notifier_cron()
{
    $request_time = Drupal::time()->getRequestTime();
    $todayDate = date('dmY', $request_time);
    $dayOfWeek = date('N', $request_time);
    $hour = date('H', $request_time);
    $last_notifications_sent = Drupal::state()->get('notifications.last.sent');

    /**
     * Send campaign emails
     */
//    if (intval($dayOfWeek) == 7) {
        if (
            (isset($last_notifications_sent) && date('dmY', $last_notifications_sent) !== $todayDate) || !isset($last_notifications_sent)
        ) {
            $dataAccessor = Drupal::service('rir_notifier.data_accessor');
            $campaigns = $dataAccessor->getComputeCampaigns();
            $campaign_processor = Drupal::queue('campaigns_processor');
            foreach ($campaigns as $sid => $advertIds) {
                $item = new StdClass();
                $item->sid = $sid;
                $item->advertIds = $advertIds;
                $campaign_processor->createItem($item);
            }
            Drupal::state()->set('notifications.last.sent', $request_time);
            Drupal::logger('rir_notifier')->notice(t('Sending notifications scheduled for @date', ['@date' => $todayDate]));
        }
//    }


    /**
     * Send adverts expiration alert
     */
    $last_expirations_sent = Drupal::state()->get('expirations.last.sent');
    if (!isset($last_expirations_sent)) {
        Drupal::state()->set('expirations.last.sent', $request_time);
        $last_expirations_sent = Drupal::state()->get('expirations.last.sent');
    }
    if (date('dmY', $last_expirations_sent) != $todayDate and intval($hour) >= 7) {
        $dataAccessor = Drupal::service('rir_notifier.data_accessor');
        $today = strtotime('now');
        $expiring_adverts = $dataAccessor->getExpiringAdvertsByDate(date('Y-m-d', $today));
        if (!empty($expiring_adverts)) {
            try {
                $mailManager = Drupal::service('plugin.manager.mail');
                $module = 'rir_interface';
                $key = 'expiring_adverts_alert';
                $to = Drupal::config('system.site')->get('mail');
                $reply = Drupal::config('system.site')->get('mail');
                $params['message'] = Markup::create(getExpiringAdvertsEmailContent($expiring_adverts, date('D d F, Y', $today)));
                $langcode = Drupal::currentUser()->getPreferredLangcode();
                $send = TRUE;
                $result = $mailManager->mail($module, $key, $to, $langcode, $params, $reply, $send);

                if (intval($result['result']) !== 1) {
                    $message = t('There was a problem sending expired adverts email.');
                    Drupal::logger('rir_notifier')
                        ->error($message . ' Whole Error: ' . json_encode($result, TRUE));
                }
                $message = t('An email of expiring adverts has been sent.');
                Drupal::logger('rir_notifier')->notice($message);
            } catch (Exception $ex) {
                Drupal::logger('rir_notifier')->error('Error sending expired adverts: ' . $ex);
            }
        }
        Drupal::state()->set('expirations.last.sent', $request_time);
        Drupal::logger('rir_notifier')->notice('Sending expired adverts scheduled!');
    }


    // Delete expired jobs
//  Drupal::logger('rir_theme')->info('Deleting expired adverts');
//  $dataAccessor = Drupal::service('rir_notifier.data_accessor');
//  $expiredAdvertIds = $dataAccessor->getExpiredAdvertIds();
//  if (!empty($expiredAdvertIds)) {
//    $remover_processor = Drupal::queue('advert_remover_processor');
//    foreach ($expiredAdvertIds as $advertId) {
//      $remover_processor->createItem($advertId);
//    }
//  }

  //Update adverts
//  $update_processor = Drupal::queue('update_adverts_processor');
//  $query = Drupal::entityTypeManager()
//    ->getStorage('node')->getQuery()
//    ->condition('type', 'advert')
//    ->condition('status', NodeInterface::PUBLISHED)
//    ->condition('field_advert_furnished', NULL, 'IS NULL');
//  $ids = $query->execute();
//  if (count($ids) > 0) {
//    Drupal::logger('Updator')->info('Found adverts: ' . count($ids));
//    foreach ($ids as $nid) {
//      $update_processor->createItem($nid);
//    }
//  } else {
//    Drupal::logger('Updator')->warning('No adverts to update');
//  }


  //update websites
  $values = [
    '17563'=>'www.premiumcontainers.co.ke',
    '17001'=>'www.property.emall.rw',
    '15640'=>'www.property.emall.rw',
    '15360'=>'www.remyproperty.com',
    '14112'=>'www.rainbowestates.rw',
    '11954'=>'www.profemmes.org',
    '11607'=>'www.isco.co.rw',
    '11150'=>'www.empirerealestate.rw',
    '10431'=>'www.ibarize.com',
    '9082'=>'www.heavenrwanda.com',
    '7321'=>'www.abahuza.com',
    '5936'=>'www.homeland.rw',
    '5101'=>'www.abbank.rw',
    '5024'=>'www.kigalihouse.com',
    '4415'=>'www.landedproperty.rw',
    '4234'=>'www.mdgroup.rw',
    '4034'=>'www.izubacity.com',
    '4021'=>'www.kigalirealtors.com',
    '4010'=>'www.kigalirealtors.com',
    '3880'=>'www.kazirealestate.rw',
    '3875'=>'www.de250.com/real-estate',
    '3807'=>'www.bestbrokers.rw',
    '3459'=>'www.rwandaproperties.com',
    '2527'=>'www.fandurealestate.rw',
    '2292'=>'www.gobeland.com',
    '2205'=>'www.facebook.com/lakhtrem',
    '2049'=>'www.centuryrwanda.com',
    '1678'=>'kivu-properties.business.site',
    '1677'=>'www.benitaconsult.com',
    '1660'=>'www.remoteestates.com',
    '1655'=>'supernaturalrwanda.wordpress.com',
    '1645'=>'www.lightbright.co.rw',
    '1643'=>'www.dominionrestate.com',
    '1635'=>'www.houseinrwanda.com',
    '1572'=>'www.beausejourhotel.rw',
    '1570'=>'www.lapalmehotel.net',
    '1568'=>'www.accordhotel.rw',
    '1566'=>'www.golfhillsresidence.com',
    '1564'=>'www.ubukihotel.com',
    '1546'=>'www.legendhotel.co.rw',
    '1545'=>'www.onomohotel.com/fr/hotel/9/onomo-hotel-kigali',
    '1544'=>'www.fivetofivehotel.com',
    '1534'=>'highlandsuiteshotel.com',
    '1533'=>'www.stipphotelrwanda.com',
    '1532'=>'www.ubumwegrandehotel.com',
    '1531'=>'www.hotelvillaportofinokigali.com',
    '1530'=>'www.olympichotelkigali.com',
    '1520'=>'www.grandlegacy.rw',
    '1519'=>'www.gloriahotelrwanda.com',
    '1518'=>'classichotelkigali.com/',
    '1509'=>'www.chezlando.com',
    '1508'=>'www.themanorhotel.rw',
    '1477'=>'www.kigalidiplomathotel.com',
    '1476'=>'www.radissonblu.com/en/hotel-kigali',
    '1475'=>'www.5swisshotel.com',
    '1474'=>'www.gorillashotels.com',
    '1465'=>'www.serenahotels.com',
    '1464'=>'www.themirrorwanda.com',
    '1463'=>'www.lemigohotel.com',
    '1462'=>'parkinn.com/hotel-kigali',
    '1414'=>'www.thecourtboutiquehotel.com',
    '1412'=>'www.hilltophotelkigali.com',
    '1396'=>'www.umubanohotel.rw',
    '1377'=>'www.millecollines.rw',
    '1159'=>'www.homes-africa.com',
    '694'=>'www.dvapparthotel.com-rwanda.com',
    '685'=>'www.kigalilife.co.rw',
    '627'=>'www.udl.rw',
    '620'=>'www.cocoonrwanda.com',
    '617'=>'www.montanavistahotel.com',
    '616'=>'www.saintjeanleopold.com',
    '615'=>'www.graziaapartments.com',
    '594'=>'www.rohiaparthotel.co.rw',
    '467'=>'www.climaxrwanda.com',
    '445'=>'savenextgeneration.wixsite.com/homebusinessnetwork',
    '390'=>'www.plutproperties.com',
    '387'=>'www.houseinrwanda.com',
    '311'=>'www.proffessionalbrokers.com',
    '289'=>'www.premierrealestate.co.rw',
    '264'=>'www.kigalilist.com',
    '249'=>'www.dnddevelopers.rw',
    '231'=>'www.homeland.rw/',
    '193'=>'www.houseinrwanda.com'
  ];
//  foreach ($values as $id => $value) {
//    $advert = Node::load(intval($id));
//    $url = Url::fromUri('https://' . $value)->toString();
//    $advert->set('field_agent_website', $url);
//    $advert->save();
//  }
}

function getCampaignHtmlContent($sid, $name, $adverts)
{
    $twig_service = Drupal::service('twig');
    $module_handler = Drupal::service('module_handler');
    $cdn_enabled = 0;
    if ($module_handler->moduleExists('cdn')) {
        $cdn_enabled = intval(Drupal::config('cdn.settings')->get('status'));
    }

    $variables = [
        'sid' => $sid,
        'recipient' => $name,
        'adverts' => $adverts,
        'cdn_enabled' => $cdn_enabled
    ];
    return $twig_service->loadTemplate(drupal_get_path('theme', 'rir') . '/emails/hir-campaign-adverts.html.twig')
        ->render($variables);
}

function getExpiringAdvertsEmailContent($expiring_adverts, $date)
{
    $counted_adverts = array();
    foreach ($expiring_adverts as $key => $expiring_advert) {
        $node_view_stats = Drupal::service('statistics.storage.node')->fetchView($expiring_advert->id());
        if ($node_view_stats !== FALSE) {
            $counted_adverts[$key . '_' . $node_view_stats->getTotalCount()] = $expiring_advert;
        } else {
            $counted_adverts[$key . '_' . 0] = $expiring_advert;
            Drupal::logger('rir_notifier')->error('Expiring advert id:' . $expiring_advert->id() . ' not found. (Maybe views count is 0)!!');
        }
    }

    $variables = [
        'counted_adverts' => $counted_adverts,
        'date' => $date
    ];
    $twig_service = Drupal::service('twig');
    return $twig_service->loadTemplate(drupal_get_path('theme', 'rir') . '/emails/hir-expiring-adverts.html.twig')
        ->render($variables);
}
